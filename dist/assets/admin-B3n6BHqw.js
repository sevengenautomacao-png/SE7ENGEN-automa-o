import{s as d,g as A}from"./supabase-CODpAGvx.js";const k=document.getElementById("adminLoginForm"),w=document.getElementById("adminLogin"),B=document.getElementById("adminDashboard"),F=document.getElementById("logoutAdmin"),p=document.getElementById("loginError"),N=document.getElementById("refreshData"),u=document.getElementById("productModal"),q=document.getElementById("productForm"),z=document.getElementById("openAddProduct"),O=document.getElementById("closeProductModal"),_=document.getElementById("categoriesList"),M=document.getElementById("newCatName"),C=document.getElementById("addCategoryBtn"),x=document.getElementById("variationBuilder"),P=document.getElementById("addVarBtn");async function R(){const{data:{user:e}}=await d.auth.getUser();if(e){const{data:t}=await d.from("profiles").select("is_admin").eq("id",e.id).single();t!=null&&t.is_admin?D():window.location.pathname.includes("admin.html")&&(w.style.display="flex",B.classList.remove("active"))}}function D(){w.style.display="none",B.classList.add("active"),H(),I(),E(),m(),g()}async function I(){const{data:e,error:t}=await d.from("categories").select("*").order("name");if(t){console.error("Erro ao buscar categorias:",t);return}_.innerHTML=e.length?"":'<span style="color: var(--text-muted);">Nenhuma categoria.</span>',e.forEach(r=>{const o=document.createElement("div");o.className="glass",o.style.cssText="padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; background: rgba(0,210,255,0.1); border: 1px solid var(--glass-border);",o.innerHTML=`
                    ${r.name}
                    <span class="delete-cat" data-id="${r.id}" style="cursor: pointer; color: #ff4d4d; font-weight: bold;">&times;</span>
                `,_.appendChild(o)});const n=document.getElementById("pCategory");n.innerHTML=e.map(r=>`<option value="${r.id}">${r.name}</option>`).join(""),n.innerHTML+='<option value="">Sem Categoria</option>',document.querySelectorAll(".delete-cat").forEach(r=>{r.onclick=async()=>{const o=r.getAttribute("data-id"),{error:a}=await d.from("categories").delete().eq("id",o);a?alert("Erro ao excluir: "+a.message):I()}})}C&&(C.onclick=async()=>{const e=M.value.trim();if(!e)return;const{error:t}=await d.from("categories").insert([{name:e}]);t?alert("Erro ao adicionar: "+t.message):(M.value="",I())});async function g(){const{data:e,error:t}=await d.from("free_shipping_rules").select("*").order("created_at",{ascending:!1}),n=document.getElementById("shippingRulesTableBody"),r=document.getElementById("shippingRuleCount");if(r&&(r.innerText=(e==null?void 0:e.length)||0),t){n.innerHTML=`<tr><td colspan="4">Erro: ${t.message}</td></tr>`;return}if(!e||e.length===0){n.innerHTML='<tr><td colspan="4" style="text-align: center;">Nenhuma regra cadastrada.</td></tr>';return}n.innerHTML=e.map(o=>`
                <tr>
                    <td><strong>${o.cep_pattern}</strong></td>
                    <td>${o.label||"Frete Gr√°tis"}</td>
                    <td>${new Date(o.created_at).toLocaleDateString("pt-BR")}</td>
                    <td>
                        <button class="btn btn-outline" style="padding: 5px 10px; color: #ff4d4d;" onclick="window.deleteShippingRule('${o.id}')">Excluir</button>
                    </td>
                </tr>
            `).join("")}window.openShippingModal=()=>{document.getElementById("shippingForm").reset(),document.getElementById("shippingModal").classList.add("active")};window.deleteShippingRule=async e=>{if(!confirm("Excluir esta regra de frete gr√°tis?"))return;const{error:t}=await d.from("free_shipping_rules").delete().eq("id",e);t?alert("Erro ao excluir: "+t.message):g()};function v(e={name:"",price:"",stock:""}){const t=document.createElement("div");t.className="variation-row",t.style.cssText="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;",t.innerHTML=`
                <input type="text" placeholder="Nome (ex: 220V)" value="${e.name}" class="glass var-name" style="padding: 5px; color: white; border: 1px solid var(--glass-border); border-radius: 4px;">
                <input type="number" placeholder="Pre√ßo" value="${e.price}" class="glass var-price" style="padding: 5px; color: white; border: 1px solid var(--glass-border); border-radius: 4px;">
                <input type="number" placeholder="Estoque" value="${e.stock}" class="glass var-stock" style="padding: 5px; color: white; border: 1px solid var(--glass-border); border-radius: 4px;">
                <span class="remove-var" style="cursor: pointer; color: #ff4d4d; font-weight: bold; font-size: 1.2rem;">&times;</span>
            `,x.appendChild(t),t.querySelector(".remove-var").onclick=()=>t.remove()}P&&(P.onclick=()=>v());function V(){const e=document.querySelectorAll(".variation-row");return Array.from(e).map(t=>({name:t.querySelector(".var-name").value,price:parseFloat(t.querySelector(".var-price").value)||0,stock:parseInt(t.querySelector(".var-stock").value)||0})).filter(t=>t.name)}k.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("adminEmail").value,n=document.getElementById("adminPass").value;p.style.display="none";const{data:r,error:o}=await d.auth.signInWithPassword({email:t,password:n});if(o){p.innerText="Erro ao entrar: "+o.message,p.style.display="block";return}const{data:a}=await d.from("profiles").select("is_admin").eq("id",r.user.id).single();a!=null&&a.is_admin?D():(p.innerText="Acesso negado: Voc√™ n√£o tem permiss√£o de administrador.",p.style.display="block",await d.auth.signOut())});F.addEventListener("click",async()=>{await d.auth.signOut(),B.classList.remove("active"),w.style.display="flex",k.reset()});N.addEventListener("click",()=>{H(),E(),m(),g()});z.onclick=()=>{document.getElementById("modalTitle").innerText="Novo Produto",q.reset(),document.getElementById("productId").value="",x.innerHTML="",v(),u.classList.add("active")};O.onclick=()=>u.classList.remove("active");window.addEventListener("click",e=>{e.target===u&&u.classList.remove("active")});q.onsubmit=async e=>{e.preventDefault();const t=document.getElementById("productId").value,n=V(),r={name:document.getElementById("pName").value,brand:document.getElementById("pBrand").value,image_url:document.getElementById("pImage").value,description:document.getElementById("pDesc").value,category_id:document.getElementById("pCategory").value||null,price:parseFloat(document.getElementById("pPrice").value)||0,weight:parseFloat(document.getElementById("pWeight").value)||0,height:parseFloat(document.getElementById("pHeight").value)||0,width:parseFloat(document.getElementById("pWidth").value)||0,length:parseFloat(document.getElementById("pLength").value)||0};let o=t;try{if(t){const{error:a}=await d.from("products").update(r).eq("id",t);if(a)throw new Error("Erro ao atualizar produto base: "+a.message)}else{const{data:a,error:i}=await d.from("products").insert([r]).select().single();if(i)throw new Error("Erro ao criar produto: "+i.message);if(!a)throw new Error("Erro: Produto criado mas nenhum dado retornado.");o=a.id}if(t){const{error:a}=await d.from("product_variations").delete().eq("product_id",t);a&&console.warn("Aviso ao limpar varia√ß√µes antigas:",a.message)}if(n.length>0){if(!o)throw new Error("Erro interno: ID do produto n√£o encontrado para salvar varia√ß√µes.");const a=n.map(l=>({...l,product_id:o})),{error:i}=await d.from("product_variations").insert(a);if(i)throw new Error("Erro ao salvar varia√ß√µes: "+i.message)}u.classList.remove("active"),E(),alert("Produto salvo com sucesso!")}catch(a){console.error("Erro no salvamento:",a),alert(a.message)}};async function E(){const{data:e,error:t}=await d.from("products").select("*, categories(name)").order("name"),n=document.getElementById("productsTableBody");if(t){n.innerHTML='<tr><td colspan="4">Erro ao carregar produtos.</td></tr>';return}n.innerHTML=e.length?"":'<tr><td colspan="5" style="text-align: center;">Nenhum produto cadastrado.</td></tr>',e.forEach(r=>{var a;const o=document.createElement("tr");o.innerHTML=`
                    <td>
                        <img src="${A(r.image_url,r.id)}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid var(--glass-border);">
                    </td>
                    <td>
                        <strong>${r.name}</strong><br>
                        <small style="color: var(--primary);">${((a=r.categories)==null?void 0:a.name)||"Sem categoria"} | ${r.brand||"Sem marca"}</small>
                    </td>
                    <td>R$ ${r.price.toFixed(2).replace(".",",")}</td>
                    <td>
                        <small style="color: var(--text-muted);">${r.description.substring(0,50)}...</small>
                    </td>
                    <td>
                        <button class="btn btn-outline edit-btn" data-id="${r.id}" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Editar</button>
                        <button class="btn btn-outline delete-btn" data-id="${r.id}" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; color: #ff4d4d; border-color: rgba(255,77,77,0.3);">Excluir</button>
                    </td>
                `,n.appendChild(o)}),document.querySelectorAll(".edit-btn").forEach(r=>{r.onclick=async()=>{const o=r.getAttribute("data-id"),a=e.find(l=>l.id===o),{data:i}=await d.from("product_variations").select("*").eq("product_id",o);document.getElementById("modalTitle").innerText="Editar Produto",document.getElementById("productId").value=a.id,document.getElementById("pName").value=a.name,document.getElementById("pPrice").value=a.price,document.getElementById("pCategory").value=a.category_id||"",document.getElementById("pBrand").value=a.brand||"",document.getElementById("pImage").value=a.image_url||"",document.getElementById("pDesc").value=a.description,document.getElementById("pWeight").value=a.weight||0,document.getElementById("pHeight").value=a.height||0,document.getElementById("pWidth").value=a.width||0,document.getElementById("pLength").value=a.length||0,x.innerHTML="",i&&i.length>0?i.forEach(l=>v(l)):v(),u.classList.add("active")}}),document.querySelectorAll(".delete-btn").forEach(r=>{r.onclick=async()=>{if(confirm("Tem certeza que deseja excluir este produto?")){const o=r.getAttribute("data-id"),{error:a}=await d.from("products").delete().eq("id",o);a?alert("Erro ao excluir: "+a.message):E()}}})}async function H(){const{data:e,error:t}=await d.from("quotes").select("*").order("created_at",{ascending:!1});if(t){console.error(t);return}const n=document.getElementById("quotesTableBody");n.innerHTML=e.length?"":'<tr><td colspan="5" style="text-align: center;">Nenhum or√ßamento encontrado.</td></tr>',e.forEach(o=>{const a=document.createElement("tr"),i=new Date(o.created_at).toLocaleDateString("pt-BR");a.innerHTML=`
                    <td>${o.client_name}</td>
                    <td>${o.service}</td>
                    <td>${i}</td>
                    <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
                    <td><button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Ver</button></td>
                `,n.appendChild(a)}),document.getElementById("pendingCount").innerText=e.filter(o=>o.status==="Pendente").length;const{count:r}=await d.from("profiles").select("*",{count:"exact",head:!0});document.getElementById("userCount").innerText=r||"0"}let b=0;const S=5;async function m(e=!1){e||(b=0,document.getElementById("ordersTableBody").innerHTML='<tr><td colspan="8" style="text-align: center;">Carregando pedidos...</td></tr>');const t=b*S,n=t+S-1,{data:r,error:o,count:a}=await d.from("orders").select("*, profiles(full_name, email)",{count:"exact"}).order("created_at",{ascending:!1}).range(t,n),i=document.getElementById("ordersTableBody"),l=document.getElementById("loadMoreOrdersContainer");if(o){console.error("Erro detalhado Supabase (Orders):",o),e||(i.innerHTML=`<tr><td colspan="8">Erro ao carregar pedidos: ${o.message}</td></tr>`);return}e||(i.innerHTML=r.length?"":'<tr><td colspan="8" style="text-align: center;">Nenhum pedido encontrado.</td></tr>'),r.forEach(s=>{var L,T;const h=new Date(s.created_at).toLocaleDateString("pt-BR"),c=s.payment_method==="pix"?"üì± PIX":"üí≥ Cart√£o",f=s.payment_status||"pending",$=document.createElement("tr");$.innerHTML=`
                    <td>#${s.id.split("-")[0]}</td>
                    <td>
                        <strong>${((L=s.profiles)==null?void 0:L.full_name)||"Usu√°rio"}</strong><br>
                        <small style="color: var(--text-muted);">${((T=s.profiles)==null?void 0:T.email)||"N/A"}</small>
                    </td>
                    <td>R$ ${s.total_amount.toFixed(2).replace(".",",")}</td>
                    <td>${h}</td>
                    <td>
                        <span style="font-size: 0.85rem;">${c}</span>
                    </td>
                    <td>
                        <select onchange="window.updatePaymentStatus('${s.id}', this.value)" class="glass status-select" style="padding: 2px 5px; border-radius: 4px; color: white; background: ${f==="approved"?"#00cc66":"#ff9900"}; font-size: 0.8rem;">
                            <option value="pending" ${f==="pending"?"selected":""}>Pendente</option>
                            <option value="approved" ${f==="approved"?"selected":""}>Aprovado</option>
                            <option value="cancelled" ${f==="cancelled"?"selected":""}>Cancelado</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="window.updateOrderStatus('${s.id}', this.value)" class="glass status-select" style="padding: 2px 5px; border-radius: 4px; color: white; background: var(--bg-card); font-size: 0.8rem;">
                            <option value="Processando" ${s.status==="Processando"?"selected":""}>Processando</option>
                            <option value="Enviado" ${s.status==="Enviado"?"selected":""}>Enviado</option>
                            <option value="Cancelado" ${s.status==="Cancelado"?"selected":""}>Cancelado</option>
                            <option value="Concluido" ${s.status==="Concluido"?"selected":""}>Concluido</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-small" onclick="window.openOrderDetails('${s.id}')" style="margin-right: 5px;">Ver</button>
                        <button class="btn btn-outline btn-small" onclick="window.deleteOrder('${s.id}')" style="color: #ff4d4d; border-color: rgba(255,77,77,0.3);">Excluir</button>
                    </td>
                `,i.appendChild($)}),document.getElementById("orderCount").innerText=a||"0",a>t+r.length?l.style.display="block":l.style.display="none"}document.getElementById("loadMoreOrdersBtn").onclick=()=>{b++,m(!0)};async function j(){const{data:e,error:t}=await d.from("orders").select("total_amount");if(!t&&e){const n=e.reduce((r,o)=>r+(parseFloat(o.total_amount)||0),0);document.getElementById("totalSales").innerText=`R$ ${n.toFixed(2).replace(".",",")}`}}j();const y=document.getElementById("orderDetailsModal"),W=document.getElementById("closeOrderDetailsModal");W.onclick=()=>y.classList.remove("active");window.addEventListener("click",e=>{e.target===y&&y.classList.remove("active")});window.openOrderDetails=async e=>{var t,n,r;document.getElementById("detailOrderId").innerText=`Pedido #${e.split("-")[0]}`,y.classList.add("active");try{const{data:o,error:a}=await d.from("orders").select("*, profiles(*)").eq("id",e).single();if(a)throw a;const{data:i,error:l}=await d.from("order_items").select("*").eq("order_id",e);if(l)throw l;document.getElementById("detailCustomerName").innerHTML=`<strong>Nome:</strong> ${((t=o.profiles)==null?void 0:t.full_name)||"N/A"}`,document.getElementById("detailCustomerEmail").innerHTML=`<strong>E-mail:</strong> ${((n=o.profiles)==null?void 0:n.email)||"N/A"}`,document.getElementById("detailCustomerPhone").innerHTML=`<strong>Telefone:</strong> ${o.contact_phone||((r=o.profiles)==null?void 0:r.phone)||"N/A"}`;const s=o.shipping_address;s?document.getElementById("detailShippingAddr").innerHTML=`
                        ${s.street}, ${s.number}<br>
                        ${s.neighborhood}<br>
                        ${s.city} - ${s.state}<br>
                        CEP: ${s.zip_code}
                    `:document.getElementById("detailShippingAddr").innerText="N√£o informado";const h=document.getElementById("detailProducts");h.innerHTML=i.map(c=>`
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="text-align: left;">
                            <span style="font-weight: 600;">${c.product_name}</span><br>
                            <small style="color: var(--text-muted);">Qtd: ${c.quantity} x R$ ${c.price_at_purchase.toFixed(2)}</small>
                        </div>
                        <div style="font-weight: 700; color: var(--primary);">
                            R$ ${(c.quantity*c.price_at_purchase).toFixed(2)}
                        </div>
                    </div>
                `).join(""),document.getElementById("detailTotal").innerText=`R$ ${o.total_amount.toFixed(2).replace(".",",")}`}catch(o){console.error("Erro ao carregar detalhes:",o),alert("Erro ao carregar detalhes do pedido."),y.classList.remove("active")}};window.updatePaymentStatus=async(e,t)=>{const{error:n}=await d.from("orders").update({payment_status:t}).eq("id",e);n?(alert("Erro ao atualizar pagamento: "+n.message),m()):(console.log(`Pagamento do pedido ${e} atualizado para ${t}`),m())};window.deleteOrder=async e=>{if(!confirm(`Tem certeza que deseja excluir o pedido #${e.split("-")[0]}? Esta a√ß√£o n√£o pode ser desfeita.`))return;const{error:t}=await d.from("orders").delete().eq("id",e);t?alert("Erro ao excluir pedido: "+t.message):m()};window.updateOrderStatus=async(e,t)=>{const{error:n}=await d.from("orders").update({status:t}).eq("id",e);n?(alert("Erro ao atualizar status: "+n.message),m()):console.log(`Status do pedido ${e} atualizado para ${t}`)};document.getElementById("shippingForm").onsubmit=async e=>{e.preventDefault();const t={cep_pattern:document.getElementById("sCep").value,label:document.getElementById("sLabel").value},{error:n}=await d.from("free_shipping_rules").insert(t);n?alert("Erro ao salvar regra: "+n.message):(document.getElementById("shippingModal").classList.remove("active"),typeof g=="function"&&g())};R();

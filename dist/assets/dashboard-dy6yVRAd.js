import{s as m,g as G}from"./supabase-CODpAGvx.js";const J="modulepreload",K=function(t){return"/"+t},q={},W=function(e,o,i){let l=Promise.resolve();if(o&&o.length>0){let u=function(y){return Promise.all(y.map(n=>Promise.resolve(n).then(E=>({status:"fulfilled",value:E}),E=>({status:"rejected",reason:E}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),f=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));l=u(o.map(y=>{if(y=K(y),y in q)return;q[y]=!0;const n=y.endsWith(".css"),E=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${E}`))return;const h=document.createElement("link");if(h.rel=n?"stylesheet":J,n||(h.as="script"),h.crossOrigin="",h.href=y,f&&h.setAttribute("nonce",f),document.head.appendChild(h),n)return new Promise((C,_)=>{h.addEventListener("load",C),h.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${y}`)))})}))}function r(u){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=u,window.dispatchEvent(a),!a.defaultPrevented)throw u}return l.then(u=>{for(const a of u||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})};new MercadoPago("APP_USR-3f5b70d8-b344-461a-900e-b8eabbb4e40d");const L=document.getElementById("userName"),X=document.getElementById("userEmail"),Y=document.getElementById("logoutBtn"),j=document.getElementById("profileForm"),S=document.getElementById("profileStatus");async function ee(){var i,l,r;const{data:{user:t}}=await m.auth.getUser();if(!t){window.location.href="index.html";return}X.innerText=t.email;const{data:e}=await m.from("profiles").select("*").eq("id",t.id).single();e?(L.innerText=`Ol√°, ${e.full_name||((i=t.user_metadata)==null?void 0:i.full_name)||"Usu√°rio"}!`,document.getElementById("profileName").value=e.full_name||"",document.getElementById("profilePhone").value=e.phone||"",document.getElementById("profileCompany").value=e.company_name||"",document.getElementById("profileCountry").value=e.country||"Brasil",document.getElementById("profileZip").value=e.zip_code||"",document.getElementById("profileState").value=e.state||"",document.getElementById("profileCity").value=e.city||"",document.getElementById("profileStreet").value=e.street||"",document.getElementById("profileNumber").value=e.number||"",document.getElementById("profileNeighborhood").value=e.neighborhood||"",document.getElementById("profileAddressNotes").value=e.address_notes||""):(L.innerText=`Ol√°, ${((l=t.user_metadata)==null?void 0:l.full_name)||"Usu√°rio"}!`,document.getElementById("profileName").value=((r=t.user_metadata)==null?void 0:r.full_name)||"");const o=document.getElementById("profileZip");o&&(o.addEventListener("blur",async()=>{const u=o.value.replace(/\D/g,"");if(u.length===8)try{const f=await(await fetch(`https://viacep.com.br/ws/${u}/json/`)).json();f.erro?(o.style.borderColor="#ff4d4d",alert("CEP n√£o encontrado! Por favor, verifique o n√∫mero digitado."),document.getElementById("profileStreet").value="",document.getElementById("profileNeighborhood").value="",document.getElementById("profileCity").value="",document.getElementById("profileState").value=""):(o.style.borderColor="var(--glass-border)",document.getElementById("profileStreet").value=f.logradouro,document.getElementById("profileNeighborhood").value=f.bairro,document.getElementById("profileCity").value=f.localidade,document.getElementById("profileState").value=f.uf,document.getElementById("profileNumber").focus())}catch(a){console.error("Erro ao buscar CEP:",a),alert("Erro ao validar o CEP. Tente novamente mais tarde.")}else u.length>0&&(o.style.borderColor="#ff4d4d",alert("Formato de CEP inv√°lido. Use 8 d√≠gitos (ex: 01001000)."))}),o.addEventListener("input",()=>{o.style.borderColor="var(--glass-border)"})),te(t.id),T(t.id),M(t.id),window.location.hash==="#cart"&&showTab("cart")}j&&j.addEventListener("submit",async t=>{t.preventDefault();const{data:{user:e}}=await m.auth.getUser(),o={id:e.id,full_name:document.getElementById("profileName").value,phone:document.getElementById("profilePhone").value,company_name:document.getElementById("profileCompany").value,country:document.getElementById("profileCountry").value,zip_code:document.getElementById("profileZip").value,state:document.getElementById("profileState").value,city:document.getElementById("profileCity").value,street:document.getElementById("profileStreet").value,number:document.getElementById("profileNumber").value,neighborhood:document.getElementById("profileNeighborhood").value,address_notes:document.getElementById("profileAddressNotes").value,updated_at:new Date},{error:i}=await m.from("profiles").upsert(o);S.style.display="block",i?(S.innerText="Erro ao atualizar: "+i.message,S.style.color="#ff4d4d"):(S.innerText="Dados atualizados com sucesso! ‚ú®",S.style.color="#00ff88",L.innerText=`Ol√°, ${o.full_name.split(" ")[0]}!`,setTimeout(()=>{S.style.display="none"},3e3))});async function te(t){const{data:e}=await m.from("quotes").select("*").eq("user_id",t).order("created_at",{ascending:!1}),o=document.getElementById("userQuotesBody");document.getElementById("quoteCount").innerText=(e==null?void 0:e.length)||0,e&&e.length>0?o.innerHTML=e.map(i=>`
                    <tr>
                        <td>${i.service}</td>
                        <td>${new Date(i.created_at).toLocaleDateString("pt-BR")}</td>
                        <td><span class="status-badge status-${i.status.toLowerCase()}">${i.status}</span></td>
                    </tr>
                `).join(""):o.innerHTML='<tr><td colspan="3" style="text-align: center;">Voc√™ ainda n√£o solicitou or√ßamentos.</td></tr>'}window.removeFromCart=async t=>{if(!confirm("Remover este item do carrinho?"))return;const{error:e}=await m.from("cart").delete().eq("id",t);if(e)alert("Erro ao remover item: "+e.message);else{const{data:{user:o}}=await m.auth.getUser();T(o.id)}};window.updateCartQuantity=async(t,e)=>{if(e<1)return;const{error:o}=await m.from("cart").update({quantity:e}).eq("id",t);if(o)console.error("Erro ao atualizar quantidade:",o);else{const{data:{user:i}}=await m.auth.getUser();T(i.id)}};async function T(t){const{data:e}=await m.from("cart").select("*, products(*)").eq("user_id",t),o=document.getElementById("userCartBody"),i=document.getElementById("cartCount");if(i.innerText=(e==null?void 0:e.length)||0,e&&e.length>0){const l=()=>{let u=0,a=e.map((n,E)=>{const h=n.products.price*n.quantity,C=n.selected!==!1;return C&&(u+=h),`
                        <tr data-id="${n.id}">
                            <td style="text-align: center;">
                                <input type="checkbox" class="cart-item-check" data-index="${E}" ${C?"checked":""}>
                            </td>
                            <td>
                                <img src="${G(n.products.image_url,n.products.id)}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;">
                            </td>
                            <td>
                                <strong>${n.products.name}</strong><br>
                                <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                                    <button onclick="window.updateCartQuantity('${n.id}', ${n.quantity-1})" class="btn btn-outline" style="padding: 2px 8px; font-size: 0.75rem;">-</button>
                                    <span style="min-width: 25px; text-align: center; font-weight: bold;">${n.quantity}</span>
                                    <button onclick="window.updateCartQuantity('${n.id}', ${n.quantity+1})" class="btn btn-outline" style="padding: 2px 8px; font-size: 0.75rem;">+</button>
                                </div>
                            </td>
                            <td>R$ ${n.products.price.toFixed(2).replace(".",",")}</td>
                            <td>R$ ${h.toFixed(2).replace(".",",")}</td>
                            <td style="text-align: center;">
                                <button onclick="window.removeFromCart('${n.id}')" class="btn btn-outline btn-small" style="padding: 5px 10px; color: #ff4d4d; border-color: rgba(255,77,77,0.3);" title="Remover">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `}).join("");a+=`
                        <tr style="background: rgba(0, 210, 255, 0.05); font-weight: 700;">
                            <td colspan="4" style="text-align: right; color: var(--primary);">Total dos Selecionados:</td>
                            <td colspan="2" style="color: var(--primary);">R$ ${u.toFixed(2).replace(".",",")}</td>
                        </tr>
                    `,o.innerHTML=a,o.querySelectorAll(".cart-item-check").forEach(n=>{n.onchange=E=>{const h=E.target.getAttribute("data-index");e[h].selected=E.target.checked,l()}});const f=e.filter(n=>n.selected!==!1),y=document.getElementById("checkoutBtn");y&&(y.disabled=f.length===0,y.innerText=f.length===0?"Selecione itens":`Finalizar Pedido (${f.length})`)};l();const r=document.getElementById("selectAllCart");r&&(r.onchange=u=>{e.forEach(a=>a.selected=u.target.checked),l()})}else{o.innerHTML='<tr><td colspan="6" style="text-align: center;">Seu carrinho est√° vazio.</td></tr>';const l=document.getElementById("checkoutBtn");l&&(l.disabled=!0,l.innerText="Carrinho Vazio")}}async function M(t){const{data:e}=await m.from("orders").select("*").eq("user_id",t).order("created_at",{ascending:!1}),o=document.getElementById("userOrdersBody");document.getElementById("orderCount").innerText=(e==null?void 0:e.length)||0,e&&e.length>0?o.innerHTML=e.map(i=>`
                    <tr>
                        <td>#${i.id.split("-")[0]}</td>
                        <td>${new Date(i.created_at).toLocaleDateString("pt-BR")}</td>
                        <td>R$ ${i.total_amount.toFixed(2).replace(".",",")}</td>
                        <td><span class="status-badge status-done">${i.status}</span></td>
                    </tr>
                `).join(""):o.innerHTML='<tr><td colspan="4" style="text-align: center;">Nenhum pedido realizado.</td></tr>'}window.handleCheckout=async function(){const{data:{user:t}}=await m.auth.getUser();if(!t)return;const o=Array.from(document.querySelectorAll(".cart-item-check:checked")).map(c=>c.closest("tr").getAttribute("data-id"));if(o.length===0){alert("Selecione pelo menos um item para finalizar o pedido!");return}const{data:i}=await m.from("cart").select("*, products(*)").eq("user_id",t.id),l=i.filter(c=>o.includes(c.id));if(!l||l.length===0){alert("Itens selecionados n√£o encontrados!");return}const{data:r}=await m.from("profiles").select("*").eq("id",t.id).single(),u=document.getElementById("shippingModal"),a=document.getElementById("savedAddressSection"),f=document.getElementById("savedAddressText"),y=document.getElementById("addressDivider"),n=document.getElementById("newAddressForm"),E=document.getElementById("closeShippingModal");n.reset(),r&&r.zip_code&&r.street?(a.style.display="block",y.style.display="block",f.innerText=`${r.street}, ${r.number}${r.address_notes?" ("+r.address_notes+")":""}
${r.neighborhood}, ${r.city} - ${r.state}
CEP: ${r.zip_code}`):(a.style.display="none",y.style.display="none"),u.classList.add("active"),E.onclick=()=>u.classList.remove("active");const C="83601120";let _=null;async function F(c){const g=document.getElementById("shippingOptionsList"),s=document.getElementById("shippingOptionsSection"),p=document.getElementById("orderFinalSummary");s.style.display="block",p.style.display="none",g.innerHTML='<p style="text-align: center;">Buscando melhores fretes...</p>';const B=l.map(d=>({id:d.product_id,width:d.products.width||11,height:d.products.height||17,length:d.products.length||11,weight:d.products.weight||.3,insurance_value:d.products.price,quantity:d.quantity}));try{const d=c.replace(/\D/g,""),{data:I}=await m.from("free_shipping_rules").select("*"),w=I==null?void 0:I.find(x=>{const $=x.cep_pattern.replace(/\D/g,"").replace("%",".*");return new RegExp(`^${$}`).test(d)});if(w){P([{name:w.label||"Frete Gr√°tis",price:0,delivery_time:"A combinar",id:"free_shipping",is_free:!0}]);return}}catch(d){console.error("Erro ao verificar regras de frete gr√°tis:",d)}try{const d="SEU_TOKEN_AQUI";if(d==="SEU_TOKEN_AQUI"){console.warn("Utilizando simula√ß√£o de frete. Configure seu Token do Melhor Envio."),await new Promise(x=>setTimeout(x,1e3)),P([{name:"PAC (Correios)",price:25.4,delivery_time:8,id:1},{name:"Sedex (Correios)",price:42.1,delivery_time:2,id:2},{name:"Jadlog .Package",price:28.9,delivery_time:5,id:3}]);return}const w=await(await fetch("https://melhorenvio.com.br/api/v2/me/shipment/calculate",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({from:{postal_code:C},to:{postal_code:c.replace(/\D/g,"")},products:B})})).json();if(!Array.isArray(w))throw new Error("Erro na cota√ß√£o");P(w.filter(x=>!x.error))}catch{g.innerHTML='<p style="color: #ff4d4d;">Erro ao calcular frete. Verifique o CEP.</p>'}}function P(c){const g=document.getElementById("shippingOptionsList");g.innerHTML="",c.forEach(s=>{var B;const p=document.createElement("div");p.className="glass",p.style.cssText="padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border); transition: 0.3s;",p.onmouseover=()=>p.style.borderColor="var(--primary)",p.onmouseout=()=>p.style.borderColor="var(--glass-border)",p.onclick=()=>{var d;_={method:s.name||((d=s.company)==null?void 0:d.name),price:parseFloat(s.custom_price||s.price),details:s},D()},p.innerHTML=`
                        <div>
                            <strong>${s.name||((B=s.company)==null?void 0:B.name)}</strong><br>
                            <small style="color: var(--text-muted);">Prazo: ${s.delivery_time} dias √∫teis</small>
                        </div>
                        <div style="color: var(--primary); font-weight: 700;">R$ ${(s.custom_price||s.price).toFixed(2).replace(".",",")}</div>
                    `,g.appendChild(p)})}function D(){const c=l.reduce((s,p)=>s+p.products.price*p.quantity,0),g=c+_.price;document.getElementById("shippingOptionsSection").style.display="none",document.getElementById("paymentSection").style.display="block",document.getElementById("orderFinalSummary").style.display="block",document.getElementById("summarySubtotal").innerText=`R$ ${c.toFixed(2).replace(".",",")}`,document.getElementById("summaryMethod").innerText=_.method,document.getElementById("summaryShipping").innerText=`R$ ${_.price.toFixed(2).replace(".",",")}`,document.getElementById("summaryTotal").innerText=`R$ ${g.toFixed(2).replace(".",",")}`,document.getElementById("payPix").click()}let O=null;document.getElementById("payPix").onclick=()=>{O="pix",document.getElementById("payPix").style.borderColor="var(--primary)",document.getElementById("confirmOrderBtn").disabled=!1,document.getElementById("confirmOrderBtn").innerText="Pagar com PIX"},document.getElementById("payCard").style.display="none",document.getElementById("useSavedAddressBtn").onclick=()=>{document.getElementById("savedAddressSection").style.display="none",document.getElementById("addressDivider").style.display="none",document.getElementById("newAddressForm").style.display="none",F(r.zip_code)},n.onsubmit=c=>{c.preventDefault();const g=document.getElementById("shipZip").value;document.getElementById("savedAddressSection").style.display="none",document.getElementById("addressDivider").style.display="none",document.getElementById("newAddressForm").style.display="none",F(g)},document.getElementById("confirmOrderBtn").onclick=()=>{const c=document.getElementById("newAddressForm").style.display==="none"?r:{zip_code:document.getElementById("shipZip").value,state:document.getElementById("shipState").value,city:document.getElementById("shipCity").value,street:document.getElementById("shipStreet").value,number:document.getElementById("shipNumber").value,neighborhood:document.getElementById("shipNeighborhood").value};u.classList.remove("active"),H(c,_,O)};const H=async(c,g,s)=>{const p=document.getElementById("confirmOrderBtn");p.disabled=!0,p.innerText="Processando...";try{const d=l.reduce((v,A)=>v+A.products.price*A.quantity,0)+g.price,{data:I,error:w}=await m.from("orders").insert({user_id:t.id,total_amount:d,shipping_address:c,contact_phone:c.phone||(r==null?void 0:r.phone),shipping_cost:g.price,shipping_method:g.method,shipping_details:g.details,payment_method:s,payment_status:"pending"}).select().single();if(w)throw w;try{const{PixHelper:v}=await W(async()=>{const{PixHelper:b}=await import("./pix_helper-CDHoALoG.js");return{PixHelper:b}},[]),N=new v("59213331000152","SE7ENGEN AUTOMACAO","SAO PAULO").generatePayload(d),Q=l.map(b=>({order_id:I.id,product_id:b.product_id,variation_id:b.variation_id,product_name:b.products.name,quantity:b.quantity,price_at_purchase:b.products.price})),{error:U}=await m.from("order_items").insert(Q);if(U)throw U;const{error:R}=await m.from("cart").delete().eq("user_id",t.id);if(R)throw R;const Z=`
                            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center;">
                                <div class="glass" style="padding:2rem; max-width:400px; text-align:center; position:relative;">
                                    <h2 style="color:var(--primary); margin-bottom:1rem;">Pagamento via Pix</h2>
                                    <p style="margin-bottom:1rem;">Valor Exato: <strong>R$ ${d.toFixed(2).replace(".",",")}</strong></p>
                                    
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(N)}" 
                                         style="border-radius:8px; margin-bottom:1rem; border:2px solid white;">
                                    
                                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem;">C√≥digo Copia e Cola:</p>
                                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:4px; margin-bottom:1rem; overflow-wrap:anywhere; user-select:all; font-family:monospace; font-size:0.7rem;">
                                        ${N}
                                    </div>
                                    
                                    <button id="btnConfirmPay" class="btn btn-primary" style="width:100%; margin-bottom:0.5rem;">
                                        ‚úÖ J√° paguei! Enviar Comprovante
                                    </button>
                                    <button onclick="window.location.reload()" class="btn btn-outline" style="width:100%;">Fechar</button>
                                </div>
                            </div>
                        `;document.body.insertAdjacentHTML("beforeend",Z),document.getElementById("btnConfirmPay").onclick=()=>{const b=`Ol√°! Acabei de fazer o pedido #${I.id} no valor de R$ ${d.toFixed(2)} via Pix. Segue o comprovante:`,V=`https://wa.me/551140028922?text=${encodeURIComponent(b)}`;window.open(V,"_blank"),window.location.reload()};return}catch(v){console.error("Erro Smart Pix:",v),alert("Erro ao gerar Pix: "+v.message)}const x=l.map(v=>({order_id:I.id,product_id:v.product_id,variation_id:v.variation_id,product_name:v.products.name,quantity:v.quantity,price_at_purchase:v.products.price})),{error:$}=await m.from("order_items").insert(x);if($)throw $;const{error:k}=await m.from("cart").delete().eq("user_id",t.id);if(k)throw k;alert("Pedido realizado com sucesso! üéâ"),document.getElementById("paymentSection").style.display="none",document.getElementById("orderFinalSummary").style.display="none",T(t.id),M(t.id),window.updateCartUI&&window.updateCartUI()}catch(B){console.error("Erro no checkout:",B),alert("Erro ao finalizar compra: "+B.message)}finally{p.disabled=!1,p.innerText="Confirmar e Finalizar Pedido"}},z=document.getElementById("shipZip");z.onblur=async()=>{const c=z.value.replace(/\D/g,"");if(c.length===8){const s=await(await fetch(`https://viacep.com.br/ws/${c}/json/`)).json();s.erro||(document.getElementById("shipStreet").value=s.logradouro,document.getElementById("shipNeighborhood").value=s.bairro,document.getElementById("shipCity").value=s.localidade,document.getElementById("shipState").value=s.uf)}}};window.showTab=function(t){document.querySelectorAll(".tab-content").forEach(e=>e.style.display="none"),document.getElementById(`${t}Section`).style.display="block"};Y.onclick=async()=>{await m.auth.signOut(),window.location.href="index.html"};ee();
